<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Î¥Ï€ÎµÏÎ±ÏƒÏ€Î¹ÏƒÏ„Î®Ï‚ Ï„Î·Ï‚ Î“Î·Ï‚</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        body {
            margin: 0;
            overflow: hidden;
            background: linear-gradient(135deg, #000428 0%, #004e92 100%);
            font-family: 'Press Start 2P', cursive;
            color: #00ff41;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            flex-direction: column;
            text-shadow: 0 0 5px #00ff41;
        }

        canvas {
            border: 2px solid #00ff41;
            background: radial-gradient(circle at center, #001122 0%, #000000 100%);
            display: block;
            box-shadow: 0 0 50px rgba(0, 255, 65, 0.3);
        }

        .game-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .game-container {
            position: relative;
            box-shadow: 0 0 30px #00ff41;
            border-radius: 10px;
            overflow: hidden;
        }

        #gameTitleHeader {
            font-size: 2.2em;
            margin-bottom: 20px;
            color: #fff;
            text-shadow: 0 0 20px #00ff41, 0 0 40px #00ff41;
            animation: pulse 2s ease-in-out infinite alternate;
        }

        @keyframes pulse {
            from {
                text-shadow: 0 0 20px #00ff41, 0 0 40px #00ff41;
            }
            to {
                text-shadow: 0 0 30px #00ff41, 0 0 60px #00ff41, 0 0 80px #00ff41;
            }
        }

        .hud {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #00ff41;
            font-size: 18px;
            text-shadow: 0 0 8px #00ff41;
            z-index: 10;
            pointer-events: none;
        }

        .hud .hud-left {
            display: flex;
            gap: 20px;
            align-items: center;
            pointer-events: all;
        }

        .hud-item {
            padding: 5px 10px;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #00ff41;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
            backdrop-filter: blur(5px);
        }

        #livesContainer {
            font-size: 24px;
        }

        #livesContainer::before {
            content: "Î–Ï‰Î­Ï‚:";
            font-size: 18px;
            padding-right: 5px;
        }

        .game-controls {
            margin-top: 20px;
            display: flex;
            gap: 15px;
            z-index: 12;
        }

        .game-controls button {
            background: linear-gradient(45deg, rgba(0, 0, 0, 0.7), rgba(0, 100, 0, 0.3));
            color: #00ff41;
            border: 2px solid #00ff41;
            padding: 12px 20px;
            cursor: pointer;
            font-family: 'Press Start 2P', cursive;
            font-size: 0.9em;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 255, 65, 0.5);
            transition: all 0.3s ease;
        }

        .game-controls button:hover {
            background: linear-gradient(45deg, rgba(0, 255, 65, 0.2), rgba(0, 150, 0, 0.5));
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 255, 65, 0.7);
        }

        .menu-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.95), rgba(0, 50, 100, 0.8));
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 20;
            color: #00ff41;
            text-align: center;
            text-shadow: 0 0 10px #00ff41;
            backdrop-filter: blur(10px);
        }

        .menu-container h1 {
            font-size: 2.5em;
            margin-bottom: 30px;
            color: #fff;
            text-shadow: 0 0 20px #00ff41, 0 0 40px #00ff41;
        }

        .menu-container h2 {
            font-size: 2em;
            margin-bottom: 20px;
            color: #fff;
        }

        .menu-container p {
            font-size: 1.2em;
            margin-bottom: 30px;
            max-width: 600px;
            line-height: 1.6;
        }

        .menu-container button {
            background: linear-gradient(45deg, #008000, #00b300);
            color: white;
            border: 2px solid #00ff41;
            padding: 15px 30px;
            margin: 10px;
            cursor: pointer;
            font-size: 1.1em;
            transition: all 0.3s ease;
            box-shadow: 0 0 15px rgba(0, 255, 65, 0.5);
            font-family: 'Press Start 2P', cursive;
            border-radius: 8px;
        }

        .menu-container button:hover {
            background: linear-gradient(45deg, #00b300, #00ff41);
            transform: scale(1.05) translateY(-2px);
            box-shadow: 0 5px 25px rgba(0, 255, 65, 0.8);
        }

        .menu-container input {
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #00ff41;
            color: #00ff41;
            padding: 15px;
            font-size: 1.2em;
            font-family: 'Press Start 2P', cursive;
            text-align: center;
            margin-bottom: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 255, 65, 0.3);
        }

        .menu-container input:focus {
            outline: none;
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.7);
        }

        .hidden {
            display: none !important;
        }

        .pause-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 30;
            color: #fff;
            font-size: 2em;
            text-shadow: 0 0 10px #fff;
        }

        .virtual-controls {
            position: absolute;
            bottom: 10px;
            width: 100%;
            display: flex;
            justify-content: space-around;
            padding: 10px;
            box-sizing: border-box;
            z-index: 15;
        }

        .virtual-btn {
            background: linear-gradient(45deg, rgba(0, 255, 65, 0.3), rgba(0, 255, 65, 0.6));
            color: #fff;
            border: 2px solid #00ff41;
            padding: 15px 25px;
            font-size: 1.5em;
            cursor: pointer;
            border-radius: 50%;
            width: 80px;
            height: 80px;
            display: flex;
            justify-content: center;
            align-items: center;
            touch-action: manipulation;
            box-shadow: 0 0 10px #00ff41;
            user-select: none;
        }

        .virtual-btn.shoot-btn {
            background: linear-gradient(45deg, rgba(255, 0, 65, 0.5), rgba(255, 0, 65, 0.8));
            border-color: #ff0041;
            box-shadow: 0 0 10px #ff0041;
            border-radius: 10px;
            width: 120px;
        }

        .virtual-btn:active {
            transform: scale(0.95);
        }

        #instructions p,
        #instructions ul {
            font-size: 1.1em;
            line-height: 1.6em;
            max-width: 600px;
            margin: 0 auto 20px;
            text-align: left;
        }

        #instructions ul {
            list-style-type: none;
            padding: 0;
        }

        #instructions li {
            margin-bottom: 10px;
        }

        .score-list {
            width: 90%;
            max-width: 500px;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #00ff41;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 20px #00ff41;
            margin-bottom: 20px;
        }

        .score-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #008000;
        }

        .score-item:last-child {
            border-bottom: none;
        }

        .weapon-indicator {
            position: absolute;
            top: 60px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #00ff41;
            border-radius: 5px;
            padding: 5px 10px;
            font-size: 14px;
            color: #00ff41;
        }

        footer {
            margin-top: 20px;
            padding: 10px;
            font-size: 0.8em;
            color: rgba(0, 255, 65, 0.7);
            text-align: center;
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="game-wrapper">
        <h1 id="gameTitleHeader">ğŸ›¸ Î¥Ï€ÎµÏÎ±ÏƒÏ€Î¹ÏƒÏ„Î®Ï‚ Ï„Î·Ï‚ Î“Î·Ï‚ ğŸ›¸</h1>
        <div class="game-container">
            <canvas id="gameCanvas" width="1200" height="750"></canvas>
            <div class="hud hidden" id="hud">
                <div class="hud-left">
                    <div class="hud-item">Î Î±Î¯ÎºÏ„Î·Ï‚: <span id="playerDisplay"></span></div>
                    <div class="hud-item">Î£ÎºÎ¿Ï: <span id="scoreDisplay">0</span></div>
                    <div class="hud-item">Î•Ï€Î¯Ï€ÎµÎ´Î¿: <span id="levelDisplay">1</span></div>
                    <div class="hud-item" id="livesContainer"></div>
                </div>
            </div>
            <div class="weapon-indicator hidden" id="weaponIndicator">ÎŒÏ€Î»Î¿: <span id="weaponType">ÎšÎ±Î½Î¿Î½Î¹ÎºÏŒ</span></div>
            <div class="menu-container" id="mainMenu">
                <h1>ğŸ›¸ Î¥Ï€ÎµÏÎ±ÏƒÏ€Î¹ÏƒÏ„Î®Ï‚ Ï„Î·Ï‚ Î“Î·Ï‚ ğŸ›¸</h1>
                <button onclick="showNameInput()">ÎˆÎ½Î±ÏÎ¾Î· Î Î±Î¹Ï‡Î½Î¹Î´Î¹Î¿Ï</button>
                <button onclick="showInstructions()">ÎŸÎ´Î·Î³Î¯ÎµÏ‚</button>
                <button onclick="showHighScores()">High Scores/button>
            </div>
            <div class="menu-container hidden" id="nameInput">
                <h2>Î•Î¹ÏƒÎ¬Î³ÎµÏ„Îµ Ï„Î¿ ÎŒÎ½Î¿Î¼Î¬ ÏƒÎ±Ï‚</h2>
                <input type="text" id="playerName" placeholder="Î¤Î¿ ÏŒÎ½Î¿Î¼Î¬ ÏƒÎ±Ï‚" maxlength="15">
                <button onclick="startGame()">ÎˆÎ½Î±ÏÎ¾Î·!</button>
                <button onclick="showMainMenu()">Î Î¯ÏƒÏ‰ ÏƒÏ„Î¿ ÎœÎµÎ½Î¿Ï</button>
            </div>
            <div class="menu-container hidden" id="instructions">
                <h2>ÎŸÎ´Î·Î³Î¯ÎµÏ‚</h2>
                <p>Î•Î¯ÏƒÏ„Îµ Ï€Î¹Î»ÏŒÏ„Î¿Ï‚ Î´Î¹Î±ÏƒÏ„Î·Î¼Î¿Ï€Î»Î¿Î¯Î¿Ï… Ï€Î¿Ï… Ï…Ï€ÎµÏÎ±ÏƒÏ€Î¯Î¶ÎµÏ„Î±Î¹ Ï„Î· Î“Î·! ÎšÎ±Ï„Î±ÏƒÏ„ÏÎ­ÏˆÏ„Îµ ÏŒÎ»Î± Ï„Î± ÎµÏ‡Î¸ÏÎ¹ÎºÎ¬ ÏƒÎºÎ¬Ï†Î· ÏƒÎµ ÎºÎ¬Î¸Îµ ÎµÏ€Î¯Ï€ÎµÎ´Î¿ Î³Î¹Î± Î½Î± Ï€ÏÎ¿Ï‡Ï‰ÏÎ®ÏƒÎµÏ„Îµ.</p>
                <ul>
                    <li><strong>ÎšÎ¯Î½Î·ÏƒÎ·:</strong> Î Î»Î®ÎºÏ„ÏÎ± 'Î‘ÏÎ¹ÏƒÏ„ÎµÏÎ¬/Î”ÎµÎ¾Î¹Î¬' Î® 'A'/'D'</li>
                    <li><strong>Î Ï…ÏÎ¿Î²Î¿Î»Î¹ÏƒÎ¼ÏŒÏ‚:</strong> Î Î»Î®ÎºÏ„ÏÎ¿ 'Spacebar'</li>
                    <li><strong>Î Î±ÏÏƒÎ·:</strong> Î Î»Î®ÎºÏ„ÏÎ¿ 'P'</li>
                    <li><strong>Bonus:</strong> Î£Ï…Î»Î»Î­Î¾Ï„Îµ Î±Ï…Ï„Î¬ Î³Î¹Î± ÎµÎ½Î¯ÏƒÏ‡Ï…ÏƒÎ·!
                        <ul>
                            <li><span style="color: #ff4d4d;">â™¥</span> <strong>ÎšÎ±ÏÎ´Î¹Î¬:</strong> Î£Î±Ï‚ Î´Î¯Î½ÎµÎ¹ ÎµÏ€Î¹Ï€Î»Î­Î¿Î½ Î¶Ï‰Î®</li>
                            <li><span style="color: #ffff40;">â˜…</span> <strong>Î‘ÏƒÏ„Î­ÏÎ¹:</strong> Î ÏÎ¿ÏƒÎ¸Î­Ï„ÎµÎ¹ 500 Ï€ÏŒÎ½Ï„Î¿Ï…Ï‚</li>
                            <li><span style="color: #4d94ff;">â›¨</span> <strong>Î‘ÏƒÏ€Î¯Î´Î±:</strong> Î ÏÎ¿ÏƒÏ‰ÏÎ¹Î½Î® Ï€ÏÎ¿ÏƒÏ„Î±ÏƒÎ¯Î±</li>
                            <li><span style="color: #ff00ff;">W</span> <strong>ÎŒÏ€Î»Î¿:</strong> Î‘Î½Î±Î²Î±Î¸Î¼Î¯Î¶ÎµÎ¹ Ï„Î¿ ÏŒÏ€Î»Î¿ ÏƒÎ±Ï‚</li>
                        </ul>
                    </li>
                </ul>
                <button onclick="showMainMenu()">Î Î¯ÏƒÏ‰ ÏƒÏ„Î¿ ÎœÎµÎ½Î¿Ï</button>
            </div>
            <div class="menu-container hidden" id="highScores">
                <h2>High Scores</h2>
                <div class="score-list" id="scoresList"></div>
                <button onclick="clearHighScores()">ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚ Î£ÎºÎ¿Ï</button>
                <button onclick="showMainMenu()">Î Î¯ÏƒÏ‰ ÏƒÏ„Î¿ ÎœÎµÎ½Î¿Ï</button>
            </div>
            <div class="pause-overlay hidden" id="pauseOverlay">
                <div>Î Î‘Î¥Î£Î—</div>
                <button onclick="pauseGame()" style="margin-top: 20px;">Î£Ï…Î½Î­Ï‡ÎµÎ¹Î±</button>
            </div>
            <div class="menu-container hidden" id="gameOverOverlay">
                <h2 style="color: #ff4d4d;">Î¤Î•Î›ÎŸÎ£ Î Î‘Î™Î§ÎÎ™Î”Î™ÎŸÎ¥</h2>
                <p>Î¤Î¿ Î£ÎºÎ¿Ï ÏƒÎ±Ï‚: <span id="finalScoreDisplay">0</span></p>
                <button onclick="returnToMenu()">Î Î¯ÏƒÏ‰ ÏƒÏ„Î¿ ÎœÎµÎ½Î¿Ï</button>
            </div>
            <div class="menu-container hidden" id="gameWonOverlay">
                <h1 style="color: #ffff40;">ğŸ‰ ÎÎ™ÎšÎ—Î£Î‘Î¤Î•! ğŸ‰</h1>
                <p>Î¥Ï€ÎµÏÎ±ÏƒÏ€Î¹ÏƒÏ„Î®ÎºÎ±Ï„Îµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚ Ï„Î· Î“Î·!</p>
                <p>Î¤ÎµÎ»Î¹ÎºÏŒ Î£ÎºÎ¿Ï: <span id="finalWinScoreDisplay">0</span></p>
                <button onclick="returnToMenu()">Î Î¯ÏƒÏ‰ ÏƒÏ„Î¿ ÎœÎµÎ½Î¿Ï</button>
            </div>
            <div class="virtual-controls hidden" id="virtualControls">
                <button class="virtual-btn" id="leftBtn">â†</button>
                <button class="virtual-btn shoot-btn" id="shootBtn">Î Î¥Î¡Î‘</button>
                <button class="virtual-btn" id="rightBtn">â†’</button>
            </div>
        </div>
        <div class="game-controls hidden" id="gameControls">
            <button onclick="pauseGame()">Î Î±ÏÏƒÎ·</button>
            <button id="muteBtn" onclick="toggleMute()">Î£Î¯Î³Î±ÏƒÎ·</button>
            <button onclick="returnToMenu()">Î Î¯ÏƒÏ‰ ÏƒÏ„Î¿ ÎœÎµÎ½Î¿Ï</button>
        </div>
    </div>
    
    <footer>Earth Defender V.01 - Â© 2025 Dimitris Gallis - All rights reserved.</footer>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let gameState = 'menu';
        let playerName = '';
        let score = 0;
        let level = 1;
        let lives = 3;
        const maxLevel = 20;
        let engineFlicker = 0;
        const player = { x: canvas.width / 2 - 25, y: canvas.height - 70, width: 50, height: 50, speed: 7, shield: 0, weaponType: 'normal', lastShotTime: 0, fireRate: 250 };
        let bullets = [], enemyBullets = [], enemies = [], powerUps = [], stars = [], explosions = [];
        let boss = null, isBossLevel = false, levelCompleted = false, transitionTimer = 0;
        const numStars = 150;
        let lastFrameTime = 0;
        const keys = {};
        let audioContext, backgroundMusic, musicPlaying = false, isMuted = false;
        let highScores = [];

        function initAudio() {
            if (!audioContext) {
                try { audioContext = new (window.AudioContext || window.webkitAudioContext)(); }
                catch (e) { isMuted = true; console.error("AudioContext not supported."); }
            }
            if (audioContext && audioContext.state === "suspended") { audioContext.resume(); }
        }
        
        function playSound(type) {
            if (isMuted || !audioContext) return;
            const o = audioContext.createOscillator();
            const t = audioContext.createGain();
            o.connect(t); t.connect(audioContext.destination);
            let freq = 440, dur = 0.1, vol = 0.05;
            switch (type) {
                case "shoot": o.type = "triangle"; freq = 800; break;
                case "explosion": o.type = "sawtooth"; freq = 150; vol = 0.2; dur = 0.3; o.frequency.exponentialRampToValueAtTime(50, audioContext.currentTime + dur); break;
                case "powerUp": o.type = "square"; freq = 400; vol = 0.15; dur = 0.2; o.frequency.exponentialRampToValueAtTime(800, audioContext.currentTime + dur); break;
                case "playerHit": o.type = "sine"; freq = 200; vol = 0.3; dur = 0.4; o.frequency.exponentialRampToValueAtTime(100, audioContext.currentTime + dur); break;
            }
            o.frequency.setValueAtTime(freq, audioContext.currentTime);
            t.gain.setValueAtTime(vol, audioContext.currentTime);
            t.gain.exponentialRampToValueAtTime(0.0001, audioContext.currentTime + dur);
            o.start();
            o.stop(audioContext.currentTime + dur);
        }

        function createBackgroundMusic() {
            if (!audioContext || musicPlaying) return;
            backgroundMusic = audioContext.createOscillator();
            backgroundMusic.type = "sine";
            backgroundMusic.frequency.setValueAtTime(50, audioContext.currentTime);
            const gainNode = audioContext.createGain();
            gainNode.gain.setValueAtTime(0.03, audioContext.currentTime);
            backgroundMusic.connect(gainNode);
            gainNode.connect(audioContext.destination);
            backgroundMusic.start();
            musicPlaying = true;
        }

        function stopBackgroundMusic() {
            if (backgroundMusic) {
                backgroundMusic.stop();
                musicPlaying = false;
                backgroundMusic = null;
            }
        }

        function drawPlayer() {
            const p = player;
            ctx.save();
            engineFlicker = (engineFlicker + 1) % 20;
            const flameSize = 10 + (engineFlicker > 10 ? 3 : 0) + Math.random() * 2;
            ctx.fillStyle = "#ffcc00";
            ctx.beginPath();
            ctx.moveTo(p.x + p.width / 2 - 5, p.y + p.height);
            ctx.lineTo(p.x + p.width / 2 + 5, p.y + p.height);
            ctx.lineTo(p.x + p.width / 2, p.y + p.height + flameSize);
            ctx.closePath();
            ctx.fill();
            const bodyGradient = ctx.createLinearGradient(p.x, p.y, p.x, p.y + p.height);
            bodyGradient.addColorStop(0, "#00ff41");
            bodyGradient.addColorStop(1, "#00802b");
            ctx.fillStyle = bodyGradient;
            ctx.beginPath();
            ctx.moveTo(p.x + p.width / 2, p.y);
            ctx.lineTo(p.x + p.width, p.y + p.height * .8);
            ctx.lineTo(p.x + p.width * .8, p.y + p.height);
            ctx.lineTo(p.x + p.width * .2, p.y + p.height);
            ctx.lineTo(p.x, p.y + p.height * .8);
            ctx.closePath();
            ctx.fill();
            ctx.fillStyle = "#004d00";
            ctx.strokeStyle = "#00ff41";
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.arc(p.x + p.width / 2, p.y + p.height * .5, p.width * .15, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();
            if (p.shield > 0) {
                const shieldOpacity = Math.min(1, p.shield / 120);
                ctx.strokeStyle = `rgba(77, 148, 255, ${shieldOpacity})`;
                ctx.fillStyle = `rgba(77, 148, 255, ${shieldOpacity * .2})`;
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(p.x + p.width / 2, p.y + p.height / 2, p.width * .7, 0, Math.PI * 2);
                ctx.stroke();
                ctx.fill()
            }
            ctx.restore()
        }

        function drawEnemies() {
            enemies.forEach(enemy => {
                ctx.save();
                if (enemy.glowIntensity > 0) {
                    ctx.shadowColor = `rgba(255, 255, 255, ${enemy.glowIntensity})`;
                    ctx.shadowBlur = 10;
                    enemy.glowIntensity -= .05
                }
                const x = enemy.x, y = enemy.y, w = enemy.width, h = enemy.height;
                ctx.fillStyle = enemy.color;
                switch (enemy.spriteType) {
                    case 0:
                        ctx.beginPath();
                        ctx.moveTo(x, y + h / 2);
                        ctx.lineTo(x + w / 4, y);
                        ctx.lineTo(x + w / 2, y + h / 2);
                        ctx.lineTo(x + 3 * w / 4, y);
                        ctx.lineTo(x + w, y + h / 2);
                        ctx.lineTo(x + 3 * w / 4, y + h);
                        ctx.lineTo(x + w / 4, y + h);
                        ctx.closePath();
                        ctx.fill();
                        break;
                    case 1:
                        ctx.beginPath();
                        ctx.arc(x + w / 2, y + h / 2, w / 2, Math.PI, 2 * Math.PI);
                        ctx.lineTo(x + w, y + h);
                        ctx.lineTo(x + 3 * w / 4, y + h * .8);
                        ctx.lineTo(x + w / 2, y + h);
                        ctx.lineTo(x + w / 4, y + h * .8);
                        ctx.lineTo(x, y + h);
                        ctx.closePath();
                        ctx.fill();
                        break;
                    case 2:
                        ctx.beginPath();
                        ctx.moveTo(x, y + h / 2);
                        ctx.quadraticCurveTo(x + w / 2, y, x + w, y + h / 2);
                        ctx.quadraticCurveTo(x + w / 2, y + h, x, y + h / 2);
                        ctx.fill();
                        ctx.fillRect(x - w * .1, y + h * .6, w * .2, h * .2);
                        ctx.fillRect(x + w * .9, y + h * .6, w * .2, h * .2);
                        break
                }
                ctx.restore();
                if (enemy.maxHealth > 1) {
                    const healthBarWidth = enemy.width * .8,
                        healthBarHeight = 4;
                    ctx.fillStyle = "#333";
                    ctx.fillRect(enemy.x + enemy.width * .1, enemy.y - 8, healthBarWidth, healthBarHeight);
                    ctx.fillStyle = "#0f0";
                    ctx.fillRect(enemy.x + enemy.width * .1, enemy.y - 8, healthBarWidth * (enemy.health / enemy.maxHealth), healthBarHeight)
                }
            })
        }

        function drawBoss() {
            if (!boss) return;
            const b = boss;
            ctx.save();
            if (b.glowIntensity > 0) {
                ctx.shadowColor = `rgba(255, 255, 255, ${b.glowIntensity})`;
                ctx.shadowBlur = 20;
                b.glowIntensity -= .05
            }
            ctx.fillStyle = "#900048";
            ctx.fillRect(b.x, b.y + 20, b.width, b.height - 40);
            ctx.fillStyle = b.color;
            ctx.beginPath();
            ctx.moveTo(b.x, b.y + 20);
            ctx.lineTo(b.x + b.width / 2, b.y);
            ctx.lineTo(b.x + b.width, b.y + 20);
            ctx.closePath();
            ctx.fill();
            ctx.fillStyle = "#500028";
            ctx.fillRect(b.x - 20, b.y + 30, 20, 50);
            ctx.fillRect(b.x + b.width, b.y + 30, 20, 50);
            ctx.fillStyle = "#ff1a8c";
            ctx.beginPath();
            ctx.arc(b.x + b.width / 2, b.y + 30, 15, 0, Math.PI * 2);
            ctx.fill();
            ctx.restore();
            const barWidth = b.width;
            ctx.fillStyle = "#333";
            ctx.fillRect(b.x, b.y - 20, barWidth, 8);
            ctx.fillStyle = "#f00";
            ctx.fillRect(b.x, b.y - 20, barWidth * (b.health / b.maxHealth), 8);
            ctx.fillStyle = "#333";
            ctx.fillRect(b.x, b.y - 10, barWidth, 4);
            ctx.fillStyle = "#00f";
            ctx.fillRect(b.x, b.y - 10, barWidth * (b.shield / b.maxShield), 4)
        }

        function drawBullets() {
            bullets.forEach(bullet => {
                ctx.fillStyle = "#ffff00";
                ctx.shadowColor = "#ffff00";
                ctx.shadowBlur = 10;
                ctx.fillRect(bullet.x, bullet.y, bullet.width, bullet.height);
                ctx.shadowBlur = 0
            });
            enemyBullets.forEach(bullet => {
                if (bullet.laser) {
                    ctx.fillStyle = "#ff00ff";
                    ctx.shadowColor = "#ff00ff";
                    ctx.shadowBlur = 15;
                    ctx.fillRect(bullet.x, bullet.y, bullet.width, bullet.height)
                } else {
                    ctx.fillStyle = "#ff4d4d";
                    ctx.shadowColor = "#ff4d4d";
                    ctx.shadowBlur = 8;
                    ctx.beginPath();
                    ctx.arc(bullet.x + bullet.width / 2, bullet.y + bullet.height / 2, bullet.width / 2, 0, Math.PI * 2);
                    ctx.fill()
                }
                ctx.shadowBlur = 0
            })
        }

        function drawPowerUps() {
            powerUps.forEach(pu => {
                ctx.save();
                ctx.shadowColor = pu.color;
                ctx.shadowBlur = 15;
                ctx.strokeStyle = "#fff";
                ctx.lineWidth = 2;
                ctx.fillStyle = pu.color;
                const x = pu.x + pu.size / 2,
                    y = pu.y + pu.size / 2,
                    s = pu.size / 2;
                switch (pu.type) {
                    case "life":
                        ctx.beginPath();
                        ctx.moveTo(x, y + s / 4);
                        ctx.arc(x - s / 2, y - s / 4, s / 2, 0, Math.PI, true);
                        ctx.arc(x + s / 2, y - s / 4, s / 2, 0, Math.PI, true);
                        ctx.lineTo(x, y + s);
                        ctx.closePath();
                        ctx.fill();
                        ctx.stroke();
                        break;
                    case "score":
                        ctx.beginPath();
                        for (let i = 0; i < 5; i++) {
                            ctx.lineTo(x + s * Math.cos(i * 2 * Math.PI / 5 + Math.PI / 2), y + s * Math.sin(i * 2 * Math.PI / 5 + Math.PI / 2));
                            ctx.lineTo(x + s / 2 * Math.cos((i + .5) * 2 * Math.PI / 5 + Math.PI / 2), y + s / 2 * Math.sin((i + .5) * 2 * Math.PI / 5 + Math.PI / 2))
                        }
                        ctx.closePath();
                        ctx.fill();
                        ctx.stroke();
                        break;
                    case "shield":
                        ctx.beginPath();
                        ctx.moveTo(x - s, y - s);
                        ctx.lineTo(x, y - s * 1.5);
                        ctx.lineTo(x + s, y - s);
                        ctx.bezierCurveTo(x + s, y + s, x, y + s * 1.2, x - s, y + s);
                        ctx.closePath();
                        ctx.fill();
                        ctx.stroke();
                        break;
                    case "weapon":
                        ctx.font = `bold ${pu.size}px "Press Start 2P"`;
                        ctx.textAlign = "center";
                        ctx.textBaseline = "middle";
                        ctx.fillText("W", x, y + 2);
                        break
                }
                ctx.restore()
            })
        }

        function drawStars() {
            stars.forEach(star => {
                ctx.fillStyle = star.color;
                ctx.globalAlpha = star.opacity * (.5 + .5 * Math.sin(star.twinkle));
                ctx.beginPath();
                ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
                ctx.fill();
                star.twinkle += .05
            });
            ctx.globalAlpha = 1
        }

        function drawExplosions() {
            explosions.forEach(exp => {
                exp.particles.forEach(p => {
                    ctx.fillStyle = p.color;
                    ctx.globalAlpha = exp.alpha;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                    ctx.fill()
                })
            })
        }

        function createStars() {
            stars = [];
            for (let i = 0; i < numStars; i++) {
                stars.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    size: Math.random() * 2 + 1,
                    speed: Math.random() * .5 + .1,
                    opacity: Math.random() * .8 + .2,
                    twinkle: Math.random() * 100,
                    color: `hsl(${Math.random() * 360}, 100%, 80%)`
                })
            }
        }

        function createEnemies() {
            enemies = [];
            const rows = Math.min(3 + Math.floor(level / 2), 7);
            const cols = Math.min(8 + Math.floor(level / 2), 12);
            const enemyWidth = 40;
            const enemyHeight = 30;
            const startX = (canvas.width - cols * (enemyWidth + 15)) / 2;
            const startY = 120;
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    enemies.push({
                        x: startX + c * (enemyWidth + 15),
                        y: startY + r * (enemyHeight + 15),
                        width: enemyWidth,
                        height: enemyHeight,
                        color: ["#ff4040", "#ff8040", "#ffbf40"][Math.floor(Math.random() * 3)],
                        direction: 1,
                        speed: .5 + level * .1,
                        health: 1 + Math.floor(level / 3),
                        maxHealth: 1 + Math.floor(level / 3),
                        lastShotTime: Date.now() + Math.random() * 5e3,
                        glowIntensity: 0,
                        spriteType: Math.floor(Math.random() * 3)
                    });
                }
            }
        }

        function createBoss() {
            boss = {
                x: canvas.width / 2 - 75,
                y: 120,
                width: 150,
                height: 100,
                color: "#ff0080",
                health: 100 + level * 20,
                maxHealth: 100 + level * 20,
                shield: 50 + level * 10,
                maxShield: 50 + level * 10,
                speed: 1,
                direction: 1,
                lastShotTime: 0,
                fireRate: 500,
                glowIntensity: 0,
                patternTimer: 0,
                movePattern: 0,
                shootTimer: 0,
                laserActive: false
            }
        }

        function createPowerUp(x, y) {
            if (Math.random() < .2 + level * .01) {
                const types = [{
                    type: "life",
                    symbol: "â™¥",
                    color: "#ff4d4d"
                }, {
                    type: "score",
                    symbol: "â˜…",
                    color: "#ffff40"
                }, {
                    type: "shield",
                    symbol: "â›¨",
                    color: "#4d94ff"
                }, {
                    type: "weapon",
                    symbol: "W",
                    color: "#ff00ff"
                }];
                const power = types[Math.floor(Math.random() * types.length)];
                const size = 25;
                powerUps.push({
                    x: x - size / 2,
                    y: y,
                    width: size,
                    height: size,
                    speed: 2,
                    size: size,
                    ...power
                });
            }
        }

        function createExplosion(x, y, color = "#ff4d4d") {
            playSound("explosion");
            const particles = [];
            for (let i = 0; i < 15; i++) {
                particles.push({
                    x: x,
                    y: y,
                    radius: Math.random() * 3 + 1,
                    vx: (Math.random() - .5) * 4,
                    vy: (Math.random() - .5) * 4,
                    color: color
                })
            }
            explosions.push({
                particles: particles,
                alpha: 1
            });
        }

        function updatePlayer() {
            if (keys.ArrowLeft || keys.a) player.x -= player.speed;
            if (keys.ArrowRight || keys.d) player.x += player.speed;
            player.x = Math.max(0, Math.min(canvas.width - player.width, player.x));
            if (keys[" "] || keys.Space || keys.Spacebar) shoot();
            if (player.shield > 0) player.shield--;
        }
        
        function shoot() {
            const now = Date.now();
            let rate = player.fireRate;
            if (player.weaponType === "fast") {
                rate /= 3;
            }
            if (now - player.lastShotTime > rate) {
                playSound("shoot");
                if (player.weaponType === "normal" || player.weaponType === "fast") {
                    bullets.push({
                        x: player.x + player.width / 2 - 4,
                        y: player.y,
                        width: 8,
                        height: 20
                    });
                } else if (player.weaponType === "spread") {
                    bullets.push({
                        x: player.x + player.width / 2 - 4,
                        y: player.y,
                        width: 8,
                        height: 20,
                        vx: 0
                    });
                    bullets.push({
                        x: player.x,
                        y: player.y,
                        width: 8,
                        height: 20,
                        vx: -1
                    });
                    bullets.push({
                        x: player.x + player.width - 8,
                        y: player.y,
                        width: 8,
                        height: 20,
                        vx: 1
                    });
                }
                player.lastShotTime = now;
            }
        }

        function updateBullets() {
            bullets.forEach((b, i) => {
                b.y -= 10;
                if (b.vx) b.x += b.vx * 2;
                if (b.y < 0) bullets.splice(i, 1)
            });
            enemyBullets.forEach((b, i) => {
                if (b.laser) {
                    b.life--;
                    if (b.life <= 0) enemyBullets.splice(i, 1)
                } else {
                    b.y += 4 + level * .1;
                    if (b.y > canvas.height) enemyBullets.splice(i, 1)
                }
            })
        }

        function updateEnemies() {
            let advance = false;
            enemies.forEach(e => {
                e.x += e.speed * e.direction;
                if (e.x < 0 || e.x + e.width > canvas.width) advance = true;
                if (Math.random() < .001) enemyBullets.push({
                    x: e.x + e.width / 2 - 3,
                    y: e.y + e.height,
                    width: 6,
                    height: 12
                })
            });
            if (advance) enemies.forEach(e => {
                e.direction *= -1;
                e.y += 20;
                if (e.y + e.height > player.y) gameOver()
            })
        }

        function updateBoss() {
            if (!boss) return;
            boss.x += boss.speed * boss.direction;
            if (boss.x < 0 || boss.x + boss.width > canvas.width) boss.direction *= -1;
            if (Math.random() < .05) enemyBullets.push({
                x: boss.x + Math.random() * boss.width,
                y: boss.y + boss.height,
                width: 8,
                height: 16
            })
        }

        function updatePowerUps() {
            powerUps.forEach((pu, i) => {
                pu.y += pu.speed;
                if (pu.y > canvas.height) powerUps.splice(i, 1)
            })
        }

        function updateStars() {
            stars.forEach(s => {
                s.y += s.speed;
                if (s.y > canvas.height) {
                    s.y = 0;
                    s.x = Math.random() * canvas.width
                }
            })
        }

        function updateExplosions() {
            explosions.forEach((exp, i) => {
                exp.alpha -= .02;
                exp.particles.forEach(p => {
                    p.x += p.vx;
                    p.y += p.vy;
                    p.radius *= .98
                });
                if (exp.alpha <= 0) explosions.splice(i, 1)
            })
        }

        function checkCollision(obj1, obj2) {
            return obj1.x < obj2.x + obj2.width && obj1.x + obj1.width > obj2.x && obj1.y < obj2.y + obj2.height && obj1.y + obj1.height > obj2.y
        }
        
        function handleCollisions() {
            bullets.forEach((b, bi) => {
                enemies.forEach((e, ei) => {
                    if (checkCollision(b, e)) {
                        e.health--;
                        e.glowIntensity = 1;
                        bullets.splice(bi, 1);
                        if (e.health <= 0) {
                            score += 100;
                            createPowerUp(e.x + e.width / 2, e.y + e.height / 2);
                            enemies.splice(ei, 1);
                            createExplosion(e.x, e.y, e.color)
                        }
                    }
                });
                if (boss && checkCollision(b, boss)) {
                    if (boss.shield > 0) {
                        boss.shield -= 5
                    } else {
                        boss.health -= 10
                    }
                    boss.glowIntensity = 1;
                    bullets.splice(bi, 1);
                    if (boss.health <= 0) {
                        score += 5e3;
                        boss = null;
                        levelCompleted = true;
                        createExplosion(b.x, b.y, "#ff1a8c")
                    }
                }
            });
            enemyBullets.forEach((b, bi) => {
                if (checkCollision(b, player)) {
                    if (player.shield > 0) {
                        player.shield = 0
                    } else {
                        lives--;
                        if (lives <= 0) {
                            gameOver()
                        } else {
                            player.shield = 180
                        }
                    }
                    updateLivesDisplay();
                    enemyBullets.splice(bi, 1);
                    playSound("playerHit")
                }
            });
            powerUps.forEach((pu, pui) => {
                if (checkCollision(player, pu)) {
                    applyPowerUpEffect(pu.type);
                    powerUps.splice(pui, 1)
                }
            })
        }

        function applyPowerUpEffect(type) {
            playSound("powerUp");
            switch (type) {
                case "life":
                    if (lives < 6) {
                        lives++;
                    }
                    updateLivesDisplay();
                    break;
                case "score":
                    score += 500;
                    break;
                case "shield":
                    player.shield += 1200;
                    break;
                case "weapon":
                    if (player.weaponType === "normal") player.weaponType = "spread";
                    else if (player.weaponType === "spread") player.weaponType = "fast";
                    else player.weaponType = "normal";
                    break;
            }
        }

        function nextLevel() {
            level++;
            enemies = [];
            enemyBullets = [];
            powerUps = [];
            isBossLevel = level % 5 === 0;
            if (isBossLevel) {
                createBoss();
            } else {
                createEnemies();
            }
            levelCompleted = false;
        }

        function updateHUD() {
            document.getElementById("playerDisplay").textContent = playerName;
            document.getElementById("scoreDisplay").textContent = Math.floor(score);
            document.getElementById("levelDisplay").textContent = level;
            updateLivesDisplay();
            const weaponNames = {
                normal: "ÎšÎ±Î½Î¿Î½Î¹ÎºÏŒ",
                spread: "Î”Î¹Î±ÏƒÏ€Î¿ÏÎ¬Ï‚",
                fast: "Î“ÏÎ®Î³Î¿ÏÎ¿"
            };
            document.getElementById("weaponType").textContent = weaponNames[player.weaponType]
        }

        function updateLivesDisplay() {
            const livesContainer = document.getElementById("livesContainer");
            livesContainer.innerHTML = "";
            for (let i = 0; i < lives; i++) {
                livesContainer.innerHTML += "â¤ï¸"
            }
        }

        function hideAllOverlays() {
            document.querySelectorAll(".menu-container, .pause-overlay").forEach(el => el.classList.add("hidden"))
        }
        
        function startGame() {
            playerName = document.getElementById("playerName").value.trim() || "Î Î±Î¯ÎºÏ„Î·Ï‚ 1";
            score = 0;
            level = 1;
            lives = 3;
            player.shield = 0;
            player.weaponType = "normal";
            bullets = [];
            enemyBullets = [];
            enemies = [];
            powerUps = [];
            boss = null;
            isBossLevel = false;
            levelCompleted = false;
            transitionTimer = 0;
            hideAllOverlays();
            document.getElementById("hud").classList.remove("hidden");
            document.getElementById("gameTitleHeader").classList.remove("hidden");
            document.getElementById("weaponIndicator").classList.remove("hidden");
            const isTouchDevice = navigator.maxTouchPoints > 0 || "ontouchstart" in window;
            if (isTouchDevice) {
                document.getElementById("virtualControls").classList.remove("hidden");
                document.getElementById("gameControls").classList.add("hidden")
            } else {
                document.getElementById("gameControls").classList.remove("hidden");
                document.getElementById("virtualControls").classList.add("hidden")
            }
            initAudio();
            createBackgroundMusic();
            createStars();
            createEnemies();
            updateHUD();
            gameState = "playing"
        }

        function endSequenceCleanup() {
            gameState = "finished";
            stopBackgroundMusic();
            document.getElementById("hud").classList.add("hidden");
            document.getElementById("gameControls").classList.add("hidden");
            document.getElementById("virtualControls").classList.add("hidden");
            document.getElementById("weaponIndicator").classList.add("hidden");
            saveHighScore(playerName, score);
        }

        function gameOver() {
            endSequenceCleanup();
            document.getElementById("finalScoreDisplay").textContent = Math.floor(score);
            document.getElementById("gameOverOverlay").classList.remove("hidden")
        }

        function gameWon() {
            endSequenceCleanup();
            document.getElementById("finalWinScoreDisplay").textContent = Math.floor(score);
            document.getElementById("gameWonOverlay").classList.remove("hidden")
        }

        function showMainMenu() {
            hideAllOverlays();
            document.getElementById("gameTitleHeader").classList.remove("hidden");
            document.getElementById("mainMenu").classList.remove("hidden")
        }

        function showNameInput() {
            hideAllOverlays();
            document.getElementById("nameInput").classList.remove("hidden")
        }

        function showInstructions() {
            hideAllOverlays();
            document.getElementById("instructions").classList.remove("hidden")
        }

        function showHighScores() {
            displayHighScores();
            hideAllOverlays();
            document.getElementById("highScores").classList.remove("hidden")
        }

        function pauseGame() {
            if (gameState === "playing") {
                gameState = "paused";
                document.getElementById("pauseOverlay").classList.remove("hidden")
            } else if (gameState === "paused") {
                gameState = "playing";
                document.getElementById("pauseOverlay").classList.add("hidden")
            }
        }
        
        function returnToMenu() {
            gameState = "menu";
            document.getElementById("gameTitleHeader").classList.remove("hidden");
            hideAllOverlays();
            document.getElementById("mainMenu").classList.remove("hidden");
        }
        
        function toggleMute() {
            isMuted = !isMuted;
            document.getElementById("muteBtn").textContent = isMuted ? "Î‰Ï‡Î¿Ï‚" : "Î£Î¯Î³Î±ÏƒÎ·";
            if (isMuted) {
                stopBackgroundMusic()
            } else if (gameState === 'playing') {
                createBackgroundMusic()
            }
        }

        function saveHighScore(name, score) {
            const s = getHighScores();
            s.push({
                name,
                score: Math.floor(score)
            });
            s.sort((a, b) => b.score - a.score);
            localStorage.setItem("defenderOfEarthScoresGR", JSON.stringify(s.slice(0, 10)))
        }

        function getHighScores() {
            return JSON.parse(localStorage.getItem("defenderOfEarthScoresGR")) || []
        }

        function displayHighScores() {
            const scores = getHighScores();
            const list = document.getElementById("scoresList");
            list.innerHTML = "";
            if (scores.length === 0) {
                list.innerHTML = '<p style="text-align: center;">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î±ÎºÏŒÎ¼Î± High Scores.</p>';
                return
            }
            scores.forEach((entry, i) => {
                const div = document.createElement("div");
                div.className = "score-item";
                div.innerHTML = `<span>${i + 1}. ${entry.name}</span><span>${entry.score}</span>`;
                list.appendChild(div)
            })
        }

        function clearHighScores() {
            if (confirm("Î•Î¯ÏƒÏ„Îµ ÏƒÎ¯Î³Î¿Ï…ÏÎ¿Î¹ ÏŒÏ„Î¹ Î¸Î­Î»ÎµÏ„Îµ Î½Î± Î´Î¹Î±Î³ÏÎ¬ÏˆÎµÏ„Îµ ÏŒÎ»Î± Ï„Î± High Scores;")) {
                localStorage.removeItem("defenderOfEarthScoresGR");
                displayHighScores()
            }
        }
        
        function setupControls() {
            const isTouchDevice = navigator.maxTouchPoints > 0 || "ontouchstart" in window;
            if (isTouchDevice) {
                document.getElementById("gameControls").style.display = "none";
                const leftBtn = document.getElementById("leftBtn"),
                    rightBtn = document.getElementById("rightBtn"),
                    shootBtn = document.getElementById("shootBtn");
                const start = e => {
                    e.preventDefault();
                    if (e.currentTarget.id === "leftBtn") keys.ArrowLeft = true;
                    if (e.currentTarget.id === "rightBtn") keys.ArrowRight = true;
                    if (e.currentTarget.id === "shootBtn") keys[" "] = true
                };
                const end = e => {
                    e.preventDefault();
                    if (e.currentTarget.id === "leftBtn") keys.ArrowLeft = false;
                    if (e.currentTarget.id === "rightBtn") keys.ArrowRight = false;
                    if (e.currentTarget.id === "shootBtn") keys[" "] = false
                };
                leftBtn.addEventListener("touchstart", start, {
                    passive: false
                });
                leftBtn.addEventListener("touchend", end, {
                    passive: false
                });
                rightBtn.addEventListener("touchstart", start, {
                    passive: false
                });
                rightBtn.addEventListener("touchend", end, {
                    passive: false
                });
                shootBtn.addEventListener("touchstart", start, {
                    passive: false
                });
                shootBtn.addEventListener("touchend", end, {
                    passive: false
                });
            } else {
                document.getElementById("virtualControls").style.display = "none";
            }
        }
        
        window.addEventListener("keydown", e => {
            keys[e.key] = true;
            keys[e.code] = true;
            if (e.key.toLowerCase() === "p") {
                if (gameState === "playing" || gameState === "paused") pauseGame()
            }
            if (e.key === "Escape") {
                if (gameState !== "menu" && gameState !== "finished") returnToMenu()
            }
        });

        window.addEventListener("keyup", e => {
            keys[e.key] = false;
            keys[e.code] = false;
        });

        function gameLoop(currentTime) {
            lastFrameTime = currentTime;
            if (gameState === "playing") {
                updatePlayer();
                updateBullets();
                updateEnemies();
                updateBoss();
                updatePowerUps();
                updateExplosions();
                handleCollisions();
                updateHUD();

                if ((!isBossLevel && enemies.length === 0) || (isBossLevel && !boss && levelCompleted)) {
                    if (transitionTimer <= 0) {
                        levelCompleted = true;
                        transitionTimer = 120;
                    }
                }
                
                if (levelCompleted && transitionTimer > 0) {
                    transitionTimer--;
                    if (transitionTimer <= 0) {
                        if (isBossLevel && level === maxLevel) {
                            gameWon();
                        } else {
                            nextLevel();
                        }
                    }
                }
            }
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            updateStars();
            drawStars();

            if (gameState === "playing" || gameState === "paused") {
                drawEnemies();
                drawBoss();
                drawPowerUps();
                drawBullets();
                drawPlayer();
                drawExplosions();
            }
            requestAnimationFrame(gameLoop);
        }

        window.onload = () => {
            showMainMenu();
            createStars();
            setupControls();
            gameLoop(0);
        };
    </script>
</body>
</html>
